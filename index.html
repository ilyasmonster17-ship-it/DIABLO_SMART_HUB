<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diablo Hub | Morocco</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <style>
        :root{--p:#ff4500;--bg:#050505;--card:#111;--t:#fff;--border:#222;--gold:#ffd700;}
        body{background:var(--bg);color:var(--t);font-family:'Cairo',sans-serif;margin:0;padding-bottom:100px;overflow-x:hidden;}
        #startScreen{display:flex;position:fixed;inset:0;background:var(--bg);z-index:9999;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
        #mainApp{display:none;}
        header{padding:15px;display:flex;justify-content:space-between;align-items:center;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000;}
        .categories{display:flex;overflow-x:auto;gap:10px;padding:10px;white-space:nowrap;}
        .cat-btn{background:var(--card);border:1px solid var(--border);color:var(--t);padding:8px 15px;border-radius:20px;cursor:pointer;}
        .cat-btn.active{background:var(--p);color:white;}
        .post-card{background:var(--card);border:1px solid var(--border);border-radius:15px;margin:15px;padding:15px;position:relative;}
        .price-tag{position:absolute;top:10px;left:10px;background:#25d366;color:white;padding:3px 12px;border-radius:20px;font-weight:bold;}
        .btn{background:var(--p);color:white;border:none;padding:12px;border-radius:8px;cursor:pointer;width:100%;margin-top:10px;display:block;text-align:center;text-decoration:none;}
        #publishModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:10001;align-items:center;justify-content:center;padding:20px;}
        #publishModal > div{background:var(--card);padding:20px;border-radius:15px;width:100%;max-height:90vh;overflow-y:auto;}
        input,textarea,select{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--t);box-sizing:border-box;}
        .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:20000;}
        .publish-btn-main{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);width:60px;height:60px;background:var(--p);border-radius:50%;display:none;align-items:center;justify-content:center;z-index:9000;border:none;color:white;font-size:30px;}
    </style>
</head>
<body>

<div id="loading" class="loading-overlay"><i class="fas fa-spinner fa-spin" style="font-size:40px;color:var(--p)"></i><p>جاري النشر...</p></div>

<div id="startScreen">
    <h1 style="color:var(--p)">DIABLO HUB</h1>
    <p>المغرب</p>
    <button class="btn" style="max-width:250px" onclick="setRole('investor')">تصفح العقارات</button>
    <button class="btn" style="max-width:250px;background:#222;border:1px solid var(--p)" onclick="setRole('seller')">أريد النشر</button>
</div>

<div id="mainApp">
    <header>
        <span style="color:var(--p);font-weight:bold;">DIABLO HUB</span>
        <button onclick="location.reload()" style="background:none;border:none;color:white"><i class="fas fa-sync"></i></button>
    </header>

    <div class="categories">
        <button class="cat-btn active" onclick="filterCat('الكل', this)">الكل</button>
        <button class="cat-btn" onclick="filterCat('شقق', this)">شقق</button>
        <button class="cat-btn" onclick="filterCat('فيلات', this)">فيلات</button>
        <button class="cat-btn" onclick="filterCat('منازل', this)">منازل</button>
    </div>

    <div id="feed"></div>
    <button class="publish-btn-main" id="pubBtn" onclick="document.getElementById('publishModal').style.display='flex'">+</button>
</div>

<div id="publishModal">
    <div>
        <h3>نشر إعلان جديد</h3>
        <select id="pType"><option value="شقق">شقة</option><option value="فيلات">فيلا</option><option value="منازل">منزل</option></select>
        <input type="text" id="pTitle" placeholder="العنوان">
        <input type="number" id="pPrice" placeholder="السعر">
        <textarea id="pDesc" placeholder="التفاصيل"></textarea>
        <input type="tel" id="pPhone" placeholder="رقم الهاتف">
        <input type="file" id="pFiles" multiple accept="image/*" onchange="handleFiles(this.files)">
        <div id="preGrid" style="display:flex;gap:5px;margin:10px 0;overflow-x:auto;"></div>
        <button class="btn" onclick="uploadPost()">نشر الآن</button>
        <button class="btn" style="background:#000" onclick="document.getElementById('publishModal').style.display='none'">إلغاء</button>
    </div>
</div>

<script>
    // الإعدادات المحدثة بالنطاق الجديد
    const firebaseConfig = {
        apiKey: "AIzaSyCGWNteBBsejx6UISfvnTY1YmnQeom7vNg",
        authDomain: "daiblosmart.firebaseapp.com",
        projectId: "daiblosmart",
        storageBucket: "daiblosmart.appspot.com"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // معرف المتصفح لضمان الحذف الشخصي فقط
    if(!localStorage.getItem('myDiabloID')){
        localStorage.setItem('myDiabloID', 'user_' + Math.random().toString(36).substr(2, 9));
    }
    const myID = localStorage.getItem('myDiabloID');

    let tempImgs = [];
    let currentCategory = 'الكل';

    function setRole(role) {
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        if(role === 'seller') document.getElementById('pubBtn').style.display = 'flex';
        listenToPosts();
    }

    async function handleFiles(files) {
        for(let f of files) {
            const reader = new FileReader();
            reader.readAsDataURL(f);
            reader.onload = (e) => {
                // ضغط بسيط للصور لضمان الحفظ
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 600;
                    canvas.height = (img.height / img.width) * 600;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                    tempImgs.push(compressedData);
                    document.getElementById('preGrid').innerHTML += `<img src="${compressedData}" style="width:60px;height:60px;border-radius:5px;object-fit:cover;">`;
                };
            };
        }
    }

    function uploadPost() {
        const title = document.getElementById('pTitle').value;
        const price = document.getElementById('pPrice').value;
        const phone = document.getElementById('pPhone').value;
        
        if(!title || !price || tempImgs.length === 0) return alert("أكمل البيانات واضف الصور");

        document.getElementById('loading').style.display = 'flex';

        db.collection("posts").add({
            title, price, phone,
            desc: document.getElementById('pDesc').value,
            type: document.getElementById('pType').value,
            imgs: tempImgs,
            userId: myID, // ربط المنشور بمتصفحك
            time: Date.now()
        }).then(() => {
            alert("تم النشر بنجاح!");
            location.reload();
        }).catch(err => {
            alert("حدث خطأ: تأكد من تفعيل Rules في Firebase");
            document.getElementById('loading').style.display = 'none';
        });
    }

    function listenToPosts() {
        db.collection("posts").orderBy("time", "desc").onSnapshot(snap => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                if(currentCategory !== 'الكل' && p.type !== currentCategory) return;
                
                let deleteBtn = (p.userId === myID) ? 
                    `<button onclick="deletePost('${doc.id}')" style="background:red;border:none;color:white;padding:5px 10px;border-radius:5px;margin-top:5px;cursor:pointer;">حذف إعلاني</button>` : "";

                feed.innerHTML += `
                    <div class="post-card">
                        <span class="price-tag">${p.price} DH</span>
                        <div style="display:flex;overflow-x:auto;gap:10px;">
                            ${p.imgs.map(img => `<img src="${img}" style="height:150px;border-radius:10px;min-width:200px;object-fit:cover;">`).join('')}
                        </div>
                        <h3>${p.title}</h3>
                        <p>${p.desc}</p>
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <a href="tel:${p.phone}" class="btn" style="flex:1;margin-left:5px;">اتصال</a>
                            ${deleteBtn}
                        </div>
                    </div>
                `;
            });
        });
    }

    function deletePost(id) {
        if(confirm("هل أنت متأكد من حذف إعلانك؟")) {
            db.collection("posts").doc(id).delete();
        }
    }

    function filterCat(cat, btn) {
        currentCategory = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        listenToPosts();
    }
</script>
</body>
    </html>
            
